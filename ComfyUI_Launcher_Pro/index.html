<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' http://localhost:* http://127.0.0.1:* file: https://* http://*; script-src 'self' 'unsafe-inline' 'unsafe-eval' http://localhost:* http://127.0.0.1:* file: https://* http://*; style-src 'self' 'unsafe-inline' http://localhost:* http://127.0.0.1:* file: https://* http://*; connect-src 'self' http://localhost:* http://127.0.0.1:* file: https://* http://*; img-src 'self' blob: data: http://localhost:* http://127.0.0.1:* file: https://* http://*; media-src 'self' blob: data: http://localhost:* http://127.0.0.1:* file: https://* http://*; frame-src 'self' http://localhost:* http://127.0.0.1:* file: https://* http://*; child-src 'self' http://localhost:* http://127.0.0.1:* file: https://* http://*; font-src 'self' data: http://localhost:* http://127.0.0.1:* file: https://* http://*; worker-src 'self' blob: file: https://* http://*;">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> <!-- ç¦ç”¨ç¼©æ”¾ä»¥å‡å°‘èµ„æºä½¿ç”¨ -->
    <title>ComfyUIå¯åŠ¨å™¨ - æ—¥å¿—è§†å›¾</title>
    <style>
        /* å…¨å±€æ ·å¼ - ä¼˜åŒ–ç‰ˆä»¥å¹³è¡¡èµ„æºä½¿ç”¨å’Œæ˜¾ç¤ºæ•ˆæœ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; /* ç®€åŒ–å­—ä½“æ ˆ */
        }

        body {
            background: #1e1e1e;
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
            /* å¯ç”¨åŸºæœ¬ç¡¬ä»¶åŠ é€Ÿ */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* é¡¶éƒ¨æ“ä½œæ  - ä¿®å¤ï¼šè°ƒæ•´ä¸ºå³å¯¹é½ */
        #top-bar {
            height: 45px;
            background: #2d2d2d;
            border-bottom: 1px solid #444444;
            display: flex;
            align-items: center;
            padding: 0 15px;
            gap: 10px;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 9990;
            justify-content: flex-end; /* å…³é”®ï¼šæŒ‰é’®å³å¯¹é½ */
            /* ä¿æŒç®€å•ï¼Œé¿å…å¤æ‚åŠ¨ç”» */
        }

        .btn {
            padding: 6px 15px;
            background: #3d3d3d;
            color: #ffffff;
            border: 1px solid #555555;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease; /* ä¿ç•™åŸºæœ¬è¿‡æ¸¡æ•ˆæœ */
        }

            .btn:hover {
                background: #4ec9b0;
                color: #1e1e1e;
                border-color: #4ec9b0;
            }

        /* ComfyUIè§†å›¾å®¹å™¨ï¼ˆiframeï¼‰ */
        #comfyui-container {
            position: fixed;
            top: 45px;
            left: 0;
            width: 100%;
            height: calc(100vh - 45px - 30px);
            border: none;
            display: none;
            /* å¯ç”¨åŸºæœ¬çš„ç¡¬ä»¶åŠ é€Ÿ */
            will-change: auto;
            transform: none;
            -webkit-transform: none;
            /* ç¡®ä¿iframeå¯è§ */
            visibility: visible;
            opacity: 1;
            z-index: 1;
            /* ç¡®ä¿é¼ æ ‡äº‹ä»¶æ­£ç¡®ä¼ é€’åˆ°iframeå†…éƒ¨ */
            pointer-events: auto;
            /* ä¼˜åŒ–GPUåŠ é€Ÿä»¥ä¾›ComfyUIä½¿ç”¨ */
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
            -webkit-perspective: 1000;
            perspective: 1000;
        }

        /* æ—¥å¿—åŒºåŸŸï¼ˆé»˜è®¤æ—¥å¿—è§†å›¾ï¼‰ */
        #log-container {
            height: calc(100vh - 45px - 30px);
            margin-top: 45px;
            padding: 10px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.5;
            background: #1e1e1e;
            /* å¯ç”¨åŸºæœ¬çš„ç¡¬ä»¶åŠ é€Ÿ */
            transform: none;
            -webkit-transform: none;
            will-change: auto;
        }

        /* ComfyUIä¸‹çš„å¯éšè—æ—¥å¿—é¢æ¿ */
        #comfyui-log-panel {
            position: fixed;
            bottom: 30px;
            left: 0;
            width: 100%;
            height: 0;
            background: #1e1e1e;
            border-top: 1px solid #444;
            transition: height 0.3s ease; /* ä¿ç•™åŸºæœ¬çš„è¿‡æ¸¡æ•ˆæœ */
            overflow: hidden;
            z-index: 9989;
            /* å¯ç”¨åŸºæœ¬çš„ç¡¬ä»¶åŠ é€Ÿ */
            transform: none;
            -webkit-transform: none;
        }

        #log-resize-bar {
            width: 100%;
            height: 5px;
            background: #4ec9b0;
            cursor: ns-resize;
            user-select: none;
        }

        #comfyui-log-content {
            width: 100%;
            height: calc(100% - 20px);
            padding: 10px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.5;
        }

        /* æ—¥å¿—æ§åˆ¶æ  */
        #log-control {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 30px;
            background: #2d2d2d;
            border-top: 1px solid #444444;
            display: flex;
            align-items: center;
            padding: 0 10px;
            z-index: 9990;
        }

        #clear-log {
            padding: 0 10px;
            height: 25px;
            background: #f44747;
            color: #ffffff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 10px;
        }

        #auto-scroll-btn {
            padding: 0 10px;
            height: 25px;
            background: #4ec9b0;
            color: #1e1e1e;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 10px;
            transition: background 0.2s ease, color 0.2s ease; /* ä¿ç•™åŸºæœ¬è¿‡æ¸¡æ•ˆæœ */
        }

            #auto-scroll-btn.off {
                background: #888888;
                color: #ffffff;
            }

        #toggle-log-panel {
            padding: 0 10px;
            height: 25px;
            background: #6a9955;
            color: #ffffff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 10px;
        }

        .tips {
            color: #999999;
            font-size: 12px;
        }

        /* é…ç½®é¢æ¿é®ç½© */
        #config-mask {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            display: none;
        }

        #config-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            min-width: 600px;
            min-height: 400px;
            max-width: 90%;
            max-height: 90vh;
            width: 600px;
            height: auto;
            background: #2d2d2d;
            border: 2px solid #447477;
            border-radius: 8px;
            padding: 20px;
            z-index: 10001;
            display: none;
            resize: both;
            overflow: auto;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); /* é‡æ–°å¯ç”¨é˜´å½± */
            /* ä¿æŒç®€å• */
        }

        #config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #555555;
            cursor: move;
            user-select: none;
        }

            #config-header h2 {
                color: #4ec9b0;
                font-size: 18px;
                margin: 0;
            }

        .config-close-btn {
            padding: 5px 10px;
            background: #f44747;
            color: #ffffff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        /* é…ç½®é¡¹æ ·å¼ */
        .config-item {
            margin-bottom: 18px;
        }

            .config-item label {
                font-size: 14px;
                margin-bottom: 8px;
                color: #cccccc;
                display: block;
            }

        .config-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            width: 100%;
        }

        .config-input {
            flex: 1;
            padding: 8px 10px;
            background: #3d3d3d;
            border: 1px solid #555555;
            color: #ffffff;
            border-radius: 4px;
            font-size: 13px;
            min-width: 0;
        }

        .config-select {
            flex: 1;
            padding: 8px 10px;
            background: #3d3d3d;
            border: 1px solid #555555;
            color: #ffffff;
            border-radius: 4px;
            font-size: 13px;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23fff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            padding-right: 30px;
        }

        .config-btn {
            padding: 8px 15px;
            background: #4ec9b0;
            color: #1e1e1e;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            white-space: nowrap;
        }

            .config-btn:hover {
                background: #38a890;
            }

        /* é…ç½®æ“ä½œæŒ‰é’® */
        #config-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 25px;
            flex-wrap: wrap;
        }

            #config-actions button {
                padding: 10px 20px;
                font-size: 14px;
            }

        /* é…ç½®æç¤ºæ ·å¼ */
        .tips-small {
            font-size: 12px;
            color: #999999;
            margin-top: 5px;
            display: block;
        }

        .must-tip {
            color: #ffd700;
            font-size: 12px;
            margin-top: 5px;
        }

        .status-text {
            font-size: 12px;
            margin-top: 5px;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .status-success {
            color: #6a9955;
            background: rgba(106, 153, 85, 0.2);
        }

        .status-error {
            color: #f44747;
            background: rgba(244, 71, 71, 0.2);
        }

        /* æ—¥å¿—è¡Œæ ·å¼ - ä¼˜åŒ–ç‰ˆ */
        .log-line {
            margin: 2px 0;
            white-space: pre-wrap; /* ä¿ç•™ç©ºæ ¼å’Œæ¢è¡Œ */
            word-break: break-all;
            font-family: Consolas, "Courier New", monospace; /* ç­‰å®½å­—ä½“ï¼Œæ—¥å¿—æ›´æ•´é½ */
            transition: none; /* ç®€å•è¿‡æ¸¡ */
        }

            .log-line.info {
                color: #4CAF50; /* ç»¿è‰² - æ­£å¸¸ä¿¡æ¯ */
            }

            .log-line.warning {
                color: #FFC107; /* é»„è‰² - æé†’/è­¦å‘Š */
            }

            .log-line.error {
                color: #F44336; /* çº¢è‰² - é”™è¯¯/å¤±è´¥ */
            }

            .log-line.success {
                color: #6a9955; /* æ·±ç»¿è‰² - æˆåŠŸæç¤º */
            }

            .log-line.normal {
                color: #ffffff; /* ç™½è‰² - æ™®é€šæ—¥å¿— */
            }

        /* å“åº”å¼å¸ƒå±€ */
        @media (max-width: 768px) {
            #config-panel {
                min-width: 90%;
                padding: 15px;
            }

            .config-input-group {
                flex-direction: column;
                align-items: stretch;
            }

            .config-btn {
                width: 100%;
            }

            #top-bar {
                flex-wrap: wrap;
                height: auto;
                padding: 10px;
                justify-content: flex-end; /* å“åº”å¼ä¸‹ä¿æŒå³å¯¹é½ */
            }

            #log-container {
                height: calc(100vh - 80px - 30px);
                margin-top: 80px;
            }

            #comfyui-container {
                height: calc(100vh - 80px - 30px);
                top: 80px;
            }
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨æ“ä½œæ  - æŒ‰é’®ä½ç½®ä¸å˜ï¼Œé€šè¿‡CSSå³å¯¹é½ -->
    <div id="top-bar">
        <button class="btn" onclick="showConfigPanel()">âš™ï¸ é…ç½®ä¸­å¿ƒ</button>
        <button class="btn" onclick="startComfyUI()">â–¶ï¸ å¯åŠ¨ComfyUI</button>
        <button class="btn" onclick="stopComfyUI()">â¹ï¸ åœæ­¢ComfyUI</button>
        <button class="btn" onclick="switchToLogView()">ğŸ“‹ æ—¥å¿—è§†å›¾</button>
        <button class="btn" onclick="switchToComfyUIView()">ğŸ–¼ï¸ ComfyUIè§†å›¾</button>
    </div>

    <!-- ComfyUIè§†å›¾å®¹å™¨ -->
    <iframe id="comfyui-container" 
            frameborder="0"
            allow="accelerometer; camera; clipboard-read; clipboard-write; display-capture; encrypted-media; geolocation; gyroscope; microphone; midi; usb; fullscreen; web-share; payment; filesystem; local-network-access; cross-origin-isolated; autoplay"
            sandbox="allow-scripts allow-same-origin allow-forms allow-pointer-lock allow-downloads allow-popups allow-modals allow-top-navigation-by-user-activation allow-presentation allow-read allow-write allow-storage-access-by-user-activation allow-popups-to-escape-sandbox allow-top-navigation allow-pointer-lock"
            loading="eager"
            fetchpriority="high"
            scrolling="auto"
            style="background: #1e1e1e;"></iframe>

    <!-- æ—¥å¿—åŒºåŸŸï¼ˆé»˜è®¤è§†å›¾ï¼‰ -->
    <div id="log-container"></div>

    <!-- ComfyUIä¸‹çš„å¯éšè—æ—¥å¿—é¢æ¿ -->
    <div id="comfyui-log-panel">
        <div id="log-resize-bar"></div>
        <div id="comfyui-log-content"></div>
    </div>

    <!-- æ—¥å¿—æ§åˆ¶æ  -->
    <div id="log-control">
        <button id="clear-log" onclick="clearLogs()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
        <button id="auto-scroll-btn" onclick="toggleAutoScroll()">ğŸ“œ è‡ªåŠ¨æ»šåŠ¨ï¼šå¼€</button>
        <button id="toggle-log-panel" onclick="toggleLogPanel()">ğŸ”½ å±•å¼€æ—¥å¿—é¢æ¿</button>
        <span class="tips">ğŸ’¡ ComfyUIå¯åŠ¨æˆåŠŸåè‡ªåŠ¨åŠ è½½ç•Œé¢ | å¿«æ·é”®ï¼šCtrl+Shift+Cï¼ˆé…ç½®ï¼‰ã€Ctrl+Lï¼ˆæ¸…ç©ºæ—¥å¿—ï¼‰</span>
    </div>

    <!-- é…ç½®é¢æ¿é®ç½© -->
    <div id="config-mask" onclick="hideConfigPanel()"></div>

    <!-- é…ç½®é¢æ¿ -->
    <div id="config-panel">
        <div id="config-header">
            <h2>âš™ï¸ ComfyUI å¯åŠ¨é…ç½®</h2>
            <button class="config-close-btn" onclick="hideConfigPanel()">Ã— å…³é—­</button>
        </div>

        <!-- 1. Pythonè·¯å¾„é…ç½® -->
        <div class="config-item">
            <label>1. Pythonå¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ï¼ˆå¿…å¡«ï¼‰</label>
            <div class="config-input-group">
                <input type="text" id="python-path" class="config-input" placeholder="è¯·é€‰æ‹©python.exeæ–‡ä»¶...">
                <button class="config-btn" onclick="selectPath('python')">ğŸ“‚ é€‰æ‹©Python</button>
            </div>
            <span class="must-tip">âš ï¸ å¿…é¡»é€‰æ‹©å¯¹åº”ComfyUIçš„Pythonç¯å¢ƒ</span>
            <span class="tips-small">ç¤ºä¾‹ï¼šD:\ai\comfyui\python_embeded\python.exe</span>
            <div id="python-status" class="status-text"></div>
        </div>

        <!-- 2. ComfyUIç›®å½•é…ç½® -->
        <div class="config-item">
            <label>2. ComfyUIæœ¬ä½“ç›®å½•ï¼ˆå¿…å¡«ï¼‰</label>
            <div class="config-input-group">
                <input type="text" id="comfyui-dir" class="config-input" placeholder="è¯·é€‰æ‹©åŒ…å«main.pyçš„ComfyUIç›®å½•...">
                <button class="config-btn" onclick="selectPath('comfyui')">ğŸ“‚ é€‰æ‹©ç›®å½•</button>
            </div>
            <span class="must-tip">âš ï¸ å¿…é¡»é€‰æ‹©åŒ…å«main.pyçš„ç›®å½•</span>
            <span class="tips-small">ç¤ºä¾‹ï¼šD:\ai\ComfyUI æˆ– D:\ai\comfyui\ComfyUI</span>
            <div id="comfyui-status" class="status-text"></div>
        </div>

        <!-- 3. å¯åŠ¨ç«¯å£é…ç½® -->
        <div class="config-item">
            <label>3. å¯åŠ¨ç«¯å£</label>
            <div class="config-input-group">
                <input type="number" id="comfy-port" class="config-input" placeholder="8188" value="8188" min="1" max="65535">
            </div>
            <span class="tips-small">é»˜è®¤8188ï¼Œè‹¥ç«¯å£è¢«å ç”¨è¯·ä¿®æ”¹ï¼ˆ1-65535ï¼‰</span>
            <div id="port-status" class="status-text"></div>
        </div>

        <!-- 4. ä»£ç†é…ç½® -->
        <div class="config-item">
            <label>4. ä»£ç†è®¾ç½®</label>
            <div class="config-input-group">
                <select id="proxy-mode" class="config-select" onchange="toggleProxyInput()">
                    <option value="disabled">âŒ ä¸å¯ç”¨ä»£ç†ï¼ˆé»˜è®¤ï¼‰</option>
                    <option value="auto">âœ… è‡ªåŠ¨ä»£ç†ï¼ˆç³»ç»Ÿä»£ç†ï¼‰</option>
                    <option value="custom">ğŸ”§ è‡ªå®šä¹‰ä»£ç†åœ°å€</option>
                </select>
                <button class="config-btn" onclick="detectSystemProxy()" style="margin-left: 10px;">ğŸ” æ£€æµ‹ç³»ç»Ÿä»£ç†</button>
            </div>
            <div id="proxy-url-group" class="config-input-group" style="display: none; margin-top: 10px;">
                <input type="text" id="proxy-url" class="config-input" placeholder="ç¤ºä¾‹ï¼šhttp://127.0.0.1:7890">
            </div>
            <span class="tips-small">ä»£ç†ä»…ç”¨äºä¾èµ–å®‰è£…å’Œæ¨¡å‹ä¸‹è½½ï¼Œä¸å½±å“æœ¬åœ°è®¿é—®</span>
        </div>

        <!-- 5. è‡ªå®šä¹‰å¯åŠ¨å‚æ•° -->
        <div class="config-item">
            <label>5. è‡ªå®šä¹‰å¯åŠ¨å‚æ•°</label>
            <div class="config-input-group">
                <input type="text" id="custom-cmd" class="config-input" placeholder="ç¤ºä¾‹ï¼š--lowvram --force-upcast-attention">
            </div>
            <span class="tips-small">æ— éœ€å¡«å†™--portï¼Œç«¯å£ç”±ä¸Šæ–¹é…ç½®è‡ªåŠ¨æ‹¼æ¥</span>
            <span class="tips-small">æ€§èƒ½ä¼˜åŒ–å‚æ•°ç¤ºä¾‹ï¼š--cpu-vae --lowvram --force-fp16 --fast --disable-metadata --async-processing --pin-shared-memory</span>
        </div>

        <!-- 6. æ’ä»¶æ£€æµ‹å¤©æ•° -->
        <div class="config-item">
            <label>6. æ’ä»¶æ£€æµ‹å¤©æ•°</label>
            <div class="config-input-group">
                <input type="number" id="plugin-check-days" class="config-input" value="7" min="1" max="30">
            </div>
            <span class="tips-small">ä»…æ£€æµ‹æŒ‡å®šå¤©æ•°å†…ä¿®æ”¹/æ–°å¢çš„æ’ä»¶ï¼ˆé»˜è®¤7å¤©ï¼‰</span>
        </div>

        <!-- é…ç½®æ“ä½œæŒ‰é’® -->
        <div id="config-actions">
            <button class="config-btn" onclick="checkConfig()">ğŸ” æ£€æµ‹é…ç½®</button>
            <button class="config-btn" onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
            <button class="config-btn" onclick="hideConfigPanel()">âŒ å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        try {
            const { ipcRenderer } = require('electron');
            const fs = require('fs');
            const path = require('path');

            // DOMå…ƒç´ 
            const logContainer = document.getElementById('log-container');
            const comfyuiContainer = document.getElementById('comfyui-container');
            const comfyuiLogPanel = document.getElementById('comfyui-log-panel');
            const comfyuiLogContent = document.getElementById('comfyui-log-content');
            const logResizeBar = document.getElementById('log-resize-bar');
            const configPanel = document.getElementById('config-panel');
            const configMask = document.getElementById('config-mask');
            const configHeader = document.getElementById('config-header');
            const autoScrollBtn = document.getElementById('auto-scroll-btn');
            const toggleLogPanelBtn = document.getElementById('toggle-log-panel');
            const pythonPathInput = document.getElementById('python-path');
            const comfyuiDirInput = document.getElementById('comfyui-dir');
            const comfyPortInput = document.getElementById('comfy-port');
            const proxyModeSelect = document.getElementById('proxy-mode');
            const proxyUrlGroup = document.getElementById('proxy-url-group');
            const proxyUrlInput = document.getElementById('proxy-url');
            const customCmdInput = document.getElementById('custom-cmd');
            const pluginCheckDaysInput = document.getElementById('plugin-check-days');
            const pythonStatus = document.getElementById('python-status');
            const comfyuiStatus = document.getElementById('comfyui-status');
            const portStatus = document.getElementById('port-status');

            // å…¨å±€å˜é‡
            let isAutoScroll = true;
            let isDragging = false;
            let dragStartX, dragStartY, panelStartX, panelStartY;
            let isLogResizing = false;
            let logPanelHeight = 0;

            // ==================== é…ç½®é¢æ¿æ‹–æ‹½ ====================
            function initConfigDrag() {
                configHeader.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    dragStartX = e.clientX;
                    dragStartY = e.clientY;
                    const panelRect = configPanel.getBoundingClientRect();
                    panelStartX = panelRect.left;
                    panelStartY = panelRect.top;
                    e.preventDefault();
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    const dx = e.clientX - dragStartX;
                    const dy = e.clientY - dragStartY;
                    configPanel.style.left = `${panelStartX + dx}px`;
                    configPanel.style.top = `${panelStartY + dy}px`;
                    configPanel.style.transform = 'none';
                });

                document.addEventListener('mouseup', () => {
                    isDragging = false;
                });
            }

            // ==================== æ—¥å¿—é¢æ¿æ‹–æ‹½è°ƒæ•´é«˜åº¦ ====================
            function initLogResize() {
                logResizeBar.addEventListener('mousedown', (e) => {
                    isLogResizing = true;
                    logPanelHeight = comfyuiLogPanel.offsetHeight;
                    e.preventDefault();
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isLogResizing) return;
                    const dy = logPanelHeight + (logResizeBar.getBoundingClientRect().top - e.clientY);
                    // é™åˆ¶é«˜åº¦èŒƒå›´ï¼šæœ€å°100pxï¼Œæœ€å¤§å±å¹•é«˜åº¦-100px
                    const newHeight = Math.max(100, Math.min(window.innerHeight - 100, dy));
                    comfyuiLogPanel.style.height = `${newHeight}px`;
                    // è°ƒæ•´ComfyUIå®¹å™¨é«˜åº¦
                    comfyuiContainer.style.height = `calc(100vh - 45px - 30px - ${newHeight}px)`;
                });

                document.addEventListener('mouseup', () => {
                    isLogResizing = false;
                });
            }

            // ==================== æ—¥å¿—æ§åˆ¶ - å…³é”®ä¿®æ”¹ï¼šé‡æ„renderLogå‡½æ•° ====================
            function renderLog(logContent, type = 'normal') {
                // è¿‡æ»¤ç©ºæ—¥å¿—
                if (!logContent || logContent.trim() === '') return;

                // å®šä¹‰æ—¥å¿—ç±»å‹æ˜ å°„ï¼ˆå’Œä¸»è¿›ç¨‹ä¿æŒä¸€è‡´ï¼‰
                const typeMap = {
                    'info': 'info',       // ç»¿è‰²
                    'warning': 'warning', // é»„è‰²
                    'error': 'error',     // çº¢è‰²
                    'success': 'success', // æ·±ç»¿è‰²
                    'normal': 'normal'    // ç™½è‰²ï¼ˆé»˜è®¤ï¼‰
                };
                // ç¡®ä¿ç±»å‹æœ‰æ•ˆï¼Œé»˜è®¤normal
                const logType = typeMap[type] || 'normal';

                // å¤„ç†æ—¥å¿—å†…å®¹ï¼šä»…è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦ï¼Œä¿ç•™åŸå§‹ç©ºæ ¼å’Œæ¢è¡Œ
                const escapeHtml = (text) => {
                    return text
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#039;');
                };

                // æ‹†åˆ†ä¸»è¿›ç¨‹å‘é€çš„æ—¥å¿—ï¼ˆä¸»è¿›ç¨‹å·²å¸¦æ—¶é—´æˆ³ï¼Œæ— éœ€é‡å¤æ·»åŠ ï¼‰
                const escapedContent = escapeHtml(logContent);

                // åˆ›å»ºæ—¥å¿—è¡Œå…ƒç´ ï¼ˆé»˜è®¤æ—¥å¿—å®¹å™¨ï¼‰
                const logLine = document.createElement('div');
                logLine.className = `log-line ${logType}`;
                logLine.textContent = escapedContent; // ä½¿ç”¨textContenté¿å…HTMLæ³¨å…¥ï¼Œä¿ç•™æ ¼å¼

                // ã€æ–°å¢ã€‘ç»™å¯åŠ¨å‘½ä»¤ç›¸å…³æ—¥å¿—æ·»åŠ ç‰¹æ®Šæ ·å¼
                if (logContent.includes('å¯åŠ¨å‘½ä»¤è¯¦æƒ…') || logContent.includes('Pythonè·¯å¾„') ||
                    logContent.includes('å¯åŠ¨å‚æ•°') || logContent.includes('å®Œæ•´Pythonå‘½ä»¤') ||
                    logContent.includes('BATæ–‡ä»¶è·¯å¾„') || logContent.includes('BATæ‰§è¡Œå‘½ä»¤') ||
                    logContent.includes('å·¥ä½œç›®å½•') || logContent.includes('ç«¯å£') ||
                    logContent.includes('ä»£ç†æ¨¡å¼') || logContent.includes('è‡ªå®šä¹‰å‚æ•°')) {
                    logLine.style.background = 'rgba(76, 175, 80, 0.1)';
                    logLine.style.borderLeft = '3px solid #4CAF50';
                    logLine.style.paddingLeft = '5px';
                }

                // åˆ›å»ºComfyUIæ—¥å¿—é¢æ¿çš„æ—¥å¿—è¡Œï¼ˆå…‹éš†ï¼‰
                const logLinePanel = logLine.cloneNode(true);

                // æ·»åŠ åˆ°å®¹å™¨ - ä½¿ç”¨æ‰¹é‡æ›´æ–°å‡å°‘DOMæ“ä½œ
                logContainer.appendChild(logLine);
                comfyuiLogContent.appendChild(logLinePanel);

                // é™åˆ¶æ—¥å¿—æ•°é‡ï¼Œé˜²æ­¢è¿‡å¤šæ—¥å¿—é€ æˆæ€§èƒ½é—®é¢˜
                const maxLogLines = 1000; // æœ€å¤šä¿ç•™1000æ¡æ—¥å¿—
                while (logContainer.children.length > maxLogLines) {
                    logContainer.removeChild(logContainer.firstChild);
                }
                while (comfyuiLogContent.children.length > maxLogLines) {
                    comfyuiLogContent.removeChild(comfyuiLogContent.firstChild);
                }

                // è‡ªåŠ¨æ»šåŠ¨ - ä½¿ç”¨èŠ‚æµå‡å°‘æ€§èƒ½å½±å“
                if (isAutoScroll) {
                    // ä½¿ç”¨requestAnimationFrameä¼˜åŒ–æ»šåŠ¨æ€§èƒ½
                    requestAnimationFrame(() => {
                        logContainer.scrollTop = logContainer.scrollHeight;
                        comfyuiLogContent.scrollTop = comfyuiLogContent.scrollHeight;
                    });
                }
            }

            function toggleAutoScroll() {
                isAutoScroll = !isAutoScroll;
                if (isAutoScroll) {
                    autoScrollBtn.textContent = 'ğŸ“œ è‡ªåŠ¨æ»šåŠ¨ï¼šå¼€';
                    autoScrollBtn.classList.remove('off');
                    logContainer.scrollTop = logContainer.scrollHeight;
                    comfyuiLogContent.scrollTop = comfyuiLogContent.scrollHeight;
                } else {
                    autoScrollBtn.textContent = 'ğŸ“œ è‡ªåŠ¨æ»šåŠ¨ï¼šå…³';
                    autoScrollBtn.classList.add('off');
                }
            }

            function clearLogs() {
                if (confirm('âš ï¸ ç¡®è®¤æ¸…ç©ºæ‰€æœ‰æ—¥å¿—å—ï¼Ÿ')) {
                    logContainer.innerHTML = '';
                    comfyuiLogContent.innerHTML = '';
                    renderLog('âœ… æ—¥å¿—å·²æ¸…ç©º', 'success');
                }
            }

            // ==================== æ—¥å¿—é¢æ¿å±•å¼€/æ”¶èµ· ====================
            function toggleLogPanel() {
                if (comfyuiLogPanel.style.height === '0px' || !comfyuiLogPanel.style.height) {
                    // å±•å¼€ï¼šé»˜è®¤é«˜åº¦300px
                    comfyuiLogPanel.style.height = '300px';
                    comfyuiContainer.style.height = 'calc(100vh - 45px - 30px - 300px)';
                    toggleLogPanelBtn.textContent = 'ğŸ”¼ æ”¶èµ·æ—¥å¿—é¢æ¿';
                } else {
                    // æ”¶èµ·
                    comfyuiLogPanel.style.height = '0px';
                    comfyuiContainer.style.height = 'calc(100vh - 45px - 30px)';
                    toggleLogPanelBtn.textContent = 'ğŸ”½ å±•å¼€æ—¥å¿—é¢æ¿';
                }
            }

            // ==================== é…ç½®é¢æ¿äº¤äº’ ====================
            function showConfigPanel() {
                ipcRenderer.send('get-config');
                configPanel.style.display = 'block';
                configMask.style.display = 'block';
                if (configPanel.style.transform === 'none') {
                    configPanel.style.left = '50%';
                    configPanel.style.top = '50%';
                    configPanel.style.transform = 'translate(-50%, -50%)';
                }
            }

            function hideConfigPanel() {
                configPanel.style.display = 'none';
                configMask.style.display = 'none';
            }

            function toggleProxyInput() {
                proxyUrlGroup.style.display = proxyModeSelect.value === 'custom' ? 'flex' : 'none';
            }

            // ==================== é…ç½®æ ¡éªŒ ====================
            function checkPythonPath() {
                const pathVal = pythonPathInput.value.trim();
                pythonStatus.className = 'status-text';
                if (!pathVal) {
                    pythonStatus.textContent = 'âŒ è¯·é€‰æ‹©Pythonå¯æ‰§è¡Œæ–‡ä»¶';
                    pythonStatus.classList.add('status-error');
                    return false;
                }
                if (!fs.existsSync(pathVal) || !pathVal.toLowerCase().endsWith('.exe')) {
                    pythonStatus.textContent = 'âŒ Pythonæ–‡ä»¶ä¸å­˜åœ¨æˆ–æ ¼å¼é”™è¯¯';
                    pythonStatus.classList.add('status-error');
                    return false;
                }
                pythonStatus.textContent = 'âœ… Pythonè·¯å¾„æœ‰æ•ˆ';
                pythonStatus.classList.add('status-success');
                return true;
            }

            function checkComfyuiDir() {
                const dir = comfyuiDirInput.value.trim();
                comfyuiStatus.className = 'status-text';
                if (!dir) {
                    comfyuiStatus.textContent = 'âŒ è¯·é€‰æ‹©ComfyUIç›®å½•';
                    comfyuiStatus.classList.add('status-error');
                    return false;
                }
                if (!fs.existsSync(dir) || !fs.existsSync(path.join(dir, 'main.py'))) {
                    comfyuiStatus.textContent = 'âŒ ç›®å½•æ— æ•ˆæˆ–æ— main.pyæ–‡ä»¶';
                    comfyuiStatus.classList.add('status-error');
                    return false;
                }
                comfyuiStatus.textContent = 'âœ… ComfyUIç›®å½•æœ‰æ•ˆ';
                comfyuiStatus.classList.add('status-success');
                return true;
            }

            function checkPort() {
                const port = parseInt(comfyPortInput.value);
                portStatus.className = 'status-text';
                if (isNaN(port) || port < 1 || port > 65535) {
                    portStatus.textContent = 'âŒ ç«¯å£å¿…é¡»æ˜¯1-65535ä¹‹é—´çš„æ•°å­—';
                    portStatus.classList.add('status-error');
                    return false;
                }
                portStatus.textContent = 'âœ… ç«¯å£åˆæ³•';
                portStatus.classList.add('status-success');
                return true;
            }

            function checkConfig() {
                const isPythonValid = checkPythonPath();
                const isComfyuiValid = checkComfyuiDir();
                const isPortValid = checkPort();
                const checkDays = parseInt(pluginCheckDaysInput.value);

                if (isNaN(checkDays) || checkDays < 1 || checkDays > 30) {
                    alert('âŒ æ’ä»¶æ£€æµ‹å¤©æ•°å¿…é¡»æ˜¯1-30ä¹‹é—´çš„æ•°å­—ï¼');
                    return false;
                }

                if (isPythonValid && isComfyuiValid && isPortValid) {
                    alert('âœ… æ‰€æœ‰é…ç½®æ£€æµ‹é€šè¿‡ï¼');
                    return true;
                } else {
                    alert('âŒ é…ç½®æ£€æµ‹å¤±è´¥ï¼Œè¯·æ ¹æ®æç¤ºä¿®æ­£ï¼');
                    return false;
                }
            }

            // ==================== é…ç½®æ“ä½œ ====================
            function selectPath(type) {
                ipcRenderer.send('select-path', type);
                ipcRenderer.once('path-selected', (_, data) => {
                    if (data && data.path) {
                        if (data.type === 'python') {
                            pythonPathInput.value = data.path;
                            checkPythonPath();
                        } else if (data.type === 'comfyui') {
                            comfyuiDirInput.value = data.path;
                            checkComfyuiDir();
                        }
                        renderLog(`âœ… å·²é€‰æ‹©${data.type === 'python' ? 'Pythonè·¯å¾„' : 'ComfyUIç›®å½•'}: ${data.path}`, 'success');
                    } else {
                        renderLog('â„¹ï¸ ç”¨æˆ·å–æ¶ˆäº†è·¯å¾„é€‰æ‹©', 'info');
                    }
                });
            }

            function saveConfig() {
                if (!checkConfig()) return;
                const newConfig = {
                    pythonPath: pythonPathInput.value.trim(),
                    comfyuiDir: comfyuiDirInput.value.trim(),
                    port: parseInt(comfyPortInput.value),
                    proxy: proxyModeSelect.value,
                    proxyUrl: proxyUrlInput.value.trim(),
                    customCmd: customCmdInput.value.trim(),
                    pluginCheckDays: parseInt(pluginCheckDaysInput.value)
                };
                ipcRenderer.send('save-config', newConfig);
                ipcRenderer.once('config-saved', (_, success, msg) => {
                    if (success) {
                        renderLog('âœ… é…ç½®ä¿å­˜æˆåŠŸ', 'success');
                        alert('âœ… é…ç½®ä¿å­˜æˆåŠŸï¼');
                        hideConfigPanel();
                    } else {
                        renderLog(`âŒ é…ç½®ä¿å­˜å¤±è´¥ï¼š${msg}`, 'error');
                        alert(`âŒ é…ç½®ä¿å­˜å¤±è´¥ï¼š${msg}`);
                    }
                });
            }

            // ==================== ComfyUIå¯åœ ====================
            function startComfyUI() {
                renderLog('ğŸš€ å¼€å§‹å¯åŠ¨ComfyUI...', 'info');
                ipcRenderer.send('start-comfyui');
            }

            function stopComfyUI() {
                renderLog('â¹ï¸ å¼€å§‹åœæ­¢ComfyUI...', 'info');
                ipcRenderer.send('stop-comfyui');
            }
            
            // ==================== æ‰‹åŠ¨è§†å›¾åˆ‡æ¢ ====================
            function switchToLogView() {
                comfyuiContainer.style.display = 'none';
                logContainer.style.display = 'block';
                // æ”¶èµ·æ—¥å¿—é¢æ¿
                comfyuiLogPanel.style.height = '0px';
                comfyuiContainer.style.height = 'calc(100vh - 45px - 30px)';
                toggleLogPanelBtn.textContent = 'ğŸ”½ å±•å¼€æ—¥å¿—é¢æ¿';
                
                // æ›´æ–°çª—å£æ ‡é¢˜
                window.parent && window.parent.document && (window.parent.document.title = 'ComfyUIå¯åŠ¨å™¨ - æ—¥å¿—è§†å›¾');
                renderLog('ğŸ“‹ åˆ‡æ¢åˆ°æ—¥å¿—è§†å›¾', 'info');
            }
            
            function switchToComfyUIView() {
                // æ£€æŸ¥æ˜¯å¦å·²çŸ¥ComfyUIç«¯å£
                const port = document.getElementById('comfy-port').value || 8188;
                const comfyUrl = `http://localhost:${port}`;
                
                logContainer.style.display = 'none';
                comfyuiContainer.style.display = 'block';
                
                // ä½¿ç”¨setTimeoutç¡®ä¿DOMæ›´æ–°åå†åŠ è½½
                setTimeout(() => {
                    // æ¸…ç†ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨ä»¥é˜²æ­¢å†…å­˜æ³„æ¼
                    if (comfyuiContainer.onload) {
                        comfyuiContainer.onload = null;
                    }
                    if (comfyuiContainer.onerror) {
                        comfyuiContainer.onerror = null;
                    }
                                    
                    // è®¾ç½®iframeçš„srcå¹¶æ·»åŠ åŠ è½½ç›‘å¬
                    comfyuiContainer.src = comfyUrl;
                                    
                    // æ·»åŠ åŠ è½½çŠ¶æ€æŒ‡ç¤º
                    document.body.style.cursor = 'wait';
                                    
                    // ç›‘å¬iframeåŠ è½½å®Œæˆ
                    comfyuiContainer.onload = function() {
                        document.body.style.cursor = 'default';
                        renderLog('âœ… ComfyUIç•Œé¢åŠ è½½å®Œæˆ', 'success');
                    };
                                    
                    // ç›‘å¬iframeåŠ è½½é”™è¯¯
                    comfyuiContainer.onerror = function() {
                        document.body.style.cursor = 'default';
                        renderLog('âŒ ComfyUIç•Œé¢åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ', 'error');
                    };
                                    
                    // ç›´æ¥è®¾ç½®iframeçš„å®‰å…¨ç­–ç•¥
                    try {
                        // è®¾ç½®iframeçš„sandboxå±æ€§ä»¥å…è®¸æ›´å¤šåŠŸèƒ½
                        comfyuiContainer.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-forms allow-pointer-lock allow-downloads allow-popups allow-modals allow-top-navigation-by-user-activation allow-presentation allow-read allow-write allow-storage-access-by-user-activation allow-same-origin allow-pointer-lock');
                                            
                        // è®¾ç½®iframeçš„å®‰å…¨å¤´éƒ¨
                        comfyuiContainer.sandbox = 'allow-scripts allow-same-origin allow-forms allow-pointer-lock allow-downloads allow-popups allow-modals allow-top-navigation allow-presentation allow-storage-access-by-user-activation allow-pointer-lock';
                                            
                        // å°è¯•è®¾ç½®å®‰å…¨ç­–ç•¥
                        if (comfyuiContainer.contentWindow && comfyuiContainer.contentWindow.navigator) {
                            // é‡å†™æƒé™APIä»¥å…è®¸å¿…è¦çš„æƒé™
                            const originalQuery = comfyuiContainer.contentWindow.navigator.permissions.query;
                            comfyuiContainer.contentWindow.navigator.permissions.query = function(permissionDesc) {
                                // å¯¹äºComfyUIç›¸å…³æƒé™ï¼Œè‡ªåŠ¨æˆæƒ
                                if (permissionDesc.name === 'clipboard-read' || 
                                    permissionDesc.name === 'clipboard-write' || 
                                    permissionDesc.name === 'storage-access' ||
                                    permissionDesc.name === 'idle-detection' ||
                                    permissionDesc.name === 'geolocation' ||
                                    permissionDesc.name === 'notifications' ||
                                    permissionDesc.name === 'push' ||
                                    permissionDesc.name === 'midi' ||
                                    permissionDesc.name === 'camera' ||
                                    permissionDesc.name === 'microphone' ||
                                    permissionDesc.name === 'speaker' ||
                                    permissionDesc.name === 'device-info' ||
                                    permissionDesc.name === 'background-sync' ||
                                    permissionDesc.name === 'accessibility-events' ||
                                    permissionDesc.name === 'clipboard-read' ||
                                    permissionDesc.name === 'clipboard-write' ||
                                    permissionDesc.name === 'payment-handler' ||
                                    permissionDesc.name === 'persistent-storage' ||
                                    permissionDesc.name === 'idle-detection' ||
                                    permissionDesc.name === 'window-management' ||
                                    permissionDesc.name === 'display-capture' ||
                                    permissionDesc.name === 'filesystem' ||
                                    permissionDesc.name === 'pointer-lock') {
                                    return Promise.resolve({state: 'granted'});
                                }
                                // å…¶ä»–æƒé™ä½¿ç”¨åŸå§‹å¤„ç†
                                return originalQuery.call(this, permissionDesc);
                            };
                        }
                                            
                        // ç‰¹åˆ«å¤„ç†ComfyUI Managerçš„æƒé™
                        if (comfyuiContainer.contentDocument && comfyuiContainer.contentDocument.defaultView) {
                            // ä¸ºComfyUI Managerè®¾ç½®é¢å¤–çš„æƒé™
                            if (comfyuiContainer.contentDocument.defaultView.navigator) {
                                // é‡å†™æ–‡ä»¶ç³»ç»ŸAPIä»¥å…è®¸è®¿é—®
                                const originalPermissions = comfyuiContainer.contentDocument.defaultView.navigator.permissions;
                                if (originalPermissions && originalPermissions.query) {
                                    comfyuiContainer.contentDocument.defaultView.navigator.permissions.query = async function(descriptor) {
                                        // å…è®¸ComfyUIç›¸å…³çš„æƒé™è¯·æ±‚
                                        if (descriptor.name === 'filesystem' || descriptor.name === 'storage-access' || descriptor.name === 'downloads' || descriptor.name === 'local-fonts' || descriptor.name === 'pointer-lock') {
                                            return Promise.resolve({state: 'granted'});
                                        }
                                        // å¯¹äºå…¶ä»–æƒé™ï¼Œä½¿ç”¨åŸå§‹å¤„ç†
                                        return originalPermissions.query.call(this, descriptor);
                                    };
                                }
                                                    
                                // é‡å†™navigatoræ¥å£ä»¥ç»•è¿‡æŸäº›å®‰å…¨é™åˆ¶
                                try {
                                    Object.defineProperty(comfyuiContainer.contentDocument.defaultView.navigator, 'permissions', {
                                        value: {
                                            query: async function(descriptor) {
                                                if (descriptor.name === 'filesystem' || descriptor.name === 'storage-access' || descriptor.name === 'downloads' || descriptor.name === 'local-fonts' || descriptor.name === 'pointer-lock') {
                                                    return Promise.resolve({state: 'granted'});
                                                }
                                                return Promise.resolve({state: 'prompt'});
                                            },
                                            request: async function(permission) {
                                                return Promise.resolve({state: 'granted'});
                                            }
                                        },
                                        writable: true,
                                        configurable: true
                                    });
                                } catch (e) {
                                    // å¦‚æœObject.definePropertyå¤±è´¥ï¼ˆåœ¨æŸäº›Electronç‰ˆæœ¬ä¸­ï¼‰ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•
                                    console.log('Object.defineProperty failed:', e.message);
                                }
                            }
                        }
                                            
                        // ç¡®ä¿iframeç„¦ç‚¹å’Œäº‹ä»¶ä¼ é€’
                        setTimeout(() => {
                            try {
                                // ç¡®ä¿iframeè·å¾—ç„¦ç‚¹
                                if (comfyuiContainer.contentWindow) {
                                    comfyuiContainer.contentWindow.focus();
                                }
                                                    
                                // ç¡®ä¿iframeèƒ½å¤Ÿæ¥æ”¶é”®ç›˜å’Œé¼ æ ‡äº‹ä»¶
                                comfyuiContainer.tabIndex = 0;
                                comfyuiContainer.focus();
                                                    
                                // ç›‘å¬å¹¶è½¬å‘é¼ æ ‡äº‹ä»¶
                                comfyuiContainer.addEventListener('mouseenter', function() {
                                    if (this.contentWindow) {
                                        this.contentWindow.focus();
                                    }
                                });
                                                    
                                // ç¡®ä¿iframeæ ·å¼æ­£ç¡®
                                comfyuiContainer.style.pointerEvents = 'auto';
                                comfyuiContainer.style.webkitUserSelect = 'none';
                                comfyuiContainer.style.userSelect = 'none';
                                                    
                            } catch(e) {
                                // å¦‚æœè·¨åŸŸé™åˆ¶ä¸å…è®¸æ“ä½œï¼Œåˆ™å¿½ç•¥é”™è¯¯
                                renderLog('â„¹ï¸ iframeç„¦ç‚¹è®¾ç½®å—åˆ°è·¨åŸŸé™åˆ¶', 'info');
                            }
                        }, 500); // ç¨å¾®å»¶è¿Ÿç¡®ä¿iframeåŠ è½½å®Œæˆ
                    } catch(e) {
                        // å¿½ç•¥å¯èƒ½çš„è·¨åŸŸé”™è¯¯
                        renderLog('âš ï¸ è®¾ç½®iframeæƒé™æ—¶å‡ºç°é¢„æœŸçš„è·¨åŸŸé”™è¯¯', 'warning');
                    };
                }, 100);
                
                // æ›´æ–°çª—å£æ ‡é¢˜
                window.parent && window.parent.document && (window.parent.document.title = `ComfyUI - ç«¯å£${port}`);
                renderLog(`ğŸ–¼ï¸ åˆ‡æ¢åˆ°ComfyUIè§†å›¾ (ç«¯å£${port})`, 'info');
            }
            
            // ==================== è§†å›¾åˆ‡æ¢ ====================
            ipcRenderer.on('switch-view', (_, viewType, comfyUrl) => {
                if (viewType === 'comfyui') {
                    logContainer.style.display = 'none';
                    comfyuiContainer.style.display = 'block';
                    
                    // ç¡®ä¿iframeæ­£ç¡®åŠ è½½ComfyUI
                    if (comfyuiContainer.src !== comfyUrl) {
                        // ä½¿ç”¨setTimeoutç¡®ä¿DOMæ›´æ–°åå†åŠ è½½
                        setTimeout(() => {
                            comfyuiContainer.src = comfyUrl;
                        }, 100);
                    }
                    
                    // æ·»åŠ åŠ è½½çŠ¶æ€æŒ‡ç¤º
                    document.body.style.cursor = 'wait';
                    
                    // æ¸…ç†ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨ä»¥é˜²æ­¢å†…å­˜æ³„æ¼
                    if (comfyuiContainer.onload) {
                        comfyuiContainer.onload = null;
                    }
                    if (comfyuiContainer.onerror) {
                        comfyuiContainer.onerror = null;
                    }
                    
                    // ç›‘å¬iframeåŠ è½½å®Œæˆ
                    comfyuiContainer.onload = function() {
                        document.body.style.cursor = 'default';
                        sendLog('âœ… ComfyUIç•Œé¢åŠ è½½å®Œæˆ', 'success');
                    };
                    
                    // ç›‘å¬iframeåŠ è½½é”™è¯¯
                    comfyuiContainer.onerror = function() {
                        document.body.style.cursor = 'default';
                        sendLog('âŒ ComfyUIç•Œé¢åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ', 'error');
                    };
                } else {
                    comfyuiContainer.style.display = 'none';
                    logContainer.style.display = 'block';
                    // æ”¶èµ·æ—¥å¿—é¢æ¿
                    comfyuiLogPanel.style.height = '0px';
                    comfyuiContainer.style.height = 'calc(100vh - 45px - 30px)';
                    toggleLogPanelBtn.textContent = 'ğŸ”½ å±•å¼€æ—¥å¿—é¢æ¿';
                }
            });
            
            // ç›‘å¬åŠ è½½çŠ¶æ€æ£€æŸ¥
            ipcRenderer.on('check-comfyui-load-status', () => {
                // æ£€æŸ¥iframeæ˜¯å¦å·²åŠ è½½å†…å®¹
                try {
                    if (comfyuiContainer.contentDocument && comfyuiContainer.contentDocument.title) {
                        sendLog(`âœ… ComfyUIåŠ è½½çŠ¶æ€ï¼šå·²æˆåŠŸåŠ è½½ (${comfyuiContainer.contentDocument.title})`, 'success');
                    } else {
                        sendLog('âš ï¸ ComfyUIåŠ è½½çŠ¶æ€ï¼šä»åœ¨åŠ è½½ä¸­...', 'info');
                        // å°è¯•é‡æ–°åŠ è½½
                        setTimeout(() => {
                            if (comfyuiContainer.style.display === 'block' && 
                                comfyuiContainer.contentDocument && 
                                !comfyuiContainer.contentDocument.body.innerHTML.trim()) {
                                sendLog('ğŸ”„ å°è¯•é‡æ–°åŠ è½½ComfyUIç•Œé¢...', 'info');
                                // ä½¿ç”¨setTimeoutç¡®ä¿åœ¨ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸­é‡æ–°åŠ è½½
                                setTimeout(() => {
                                    comfyuiContainer.src = comfyuiContainer.src; // é‡æ–°åŠ è½½
                                }, 100);
                            }
                        }, 3000);
                    }
                } catch (e) {
                    // è·¨åŸŸé”™è¯¯æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºé¡µé¢è¿˜åœ¨åŠ è½½ä¸­
                    sendLog('â³ ComfyUIåŠ è½½çŠ¶æ€ï¼šé¡µé¢ä»åœ¨åŠ è½½ä¸­ï¼ˆå¯èƒ½å› è·¨åŸŸç­–ç•¥æ— æ³•è®¿é—®å†…å®¹ï¼‰', 'info');
                }
            });
            
            // æ£€æµ‹ç³»ç»Ÿä»£ç†
            function detectSystemProxy() {
                renderLog('ğŸ” æ­£åœ¨æ£€æµ‹ç³»ç»Ÿä»£ç†è®¾ç½®...', 'info');
                ipcRenderer.send('detect-system-proxy');
            }
            
            // æ¥æ”¶ç³»ç»Ÿä»£ç†æ£€æµ‹ç»“æœ
            ipcRenderer.on('system-proxy-detected', (event, result) => {
                if (result.success) {
                    renderLog(`âœ… æ£€æµ‹åˆ°ç³»ç»Ÿä»£ç†: ${result.proxy}`, 'success');
                    // å¯ä»¥é€‰æ‹©æ€§åœ°å¡«å……åˆ°è‡ªå®šä¹‰ä»£ç†è¾“å…¥æ¡†
                    if (confirm(`æ˜¯å¦å°†æ£€æµ‹åˆ°çš„ä»£ç†åœ°å€å¡«å…¥è‡ªå®šä¹‰ä»£ç†ï¼Ÿ\n\næ£€æµ‹åˆ°: ${result.proxy}`)) {
                        document.getElementById('proxy-mode').value = 'custom';
                        document.getElementById('proxy-url').value = result.proxy;
                        toggleProxyInput(); // æ›´æ–°UIæ˜¾ç¤º
                        renderLog(`ğŸ”§ å·²å°†ä»£ç†åœ°å€å¡«å…¥è‡ªå®šä¹‰ä»£ç†è®¾ç½®`, 'info');
                    }
                } else {
                    renderLog(`â„¹ï¸ æœªæ£€æµ‹åˆ°ç³»ç»Ÿä»£ç†ï¼Œå¯ä½¿ç”¨ç›´è¿æ¨¡å¼`, 'info');
                }
            });
            
            // å¤„ç†iframeå‡†å¤‡å°±ç»ªæ¶ˆæ¯
            ipcRenderer.on('ensure-iframe-ready', () => {
                // ç¡®ä¿iframeå…ƒç´ å­˜åœ¨ä¸”å·²å‡†å¤‡å°±ç»ª
                if (comfyuiContainer && comfyuiContainer.style.display === 'block') {
                    // ç¡®ä¿iframeå†…å®¹æ­£ç¡®åŠ è½½
                    const port = document.getElementById('comfy-port').value || 8188;
                    const currentSrc = comfyuiContainer.src;
                    const expectedSrc = `http://localhost:${port}`;
                    
                    if (currentSrc !== expectedSrc) {
                        // å¦‚æœiframeæ²¡æœ‰åŠ è½½æ­£ç¡®çš„URLï¼Œé‡æ–°è®¾ç½®
                        comfyuiContainer.src = expectedSrc;
                        sendLog(`ğŸ”§ ç¡®ä¿iframeåŠ è½½æ­£ç¡®URL: ${expectedSrc}`, 'info');
                    }
                }
            });
            
            // ==================== å¿«æ·é”® ====================
            function initShortcut() {
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'c') {
                        e.preventDefault();
                        showConfigPanel();
                    }
                    if (e.ctrlKey && e.key === 'l') {
                        e.preventDefault();
                        clearLogs();
                    }
                });
            }

            // ==================== åˆå§‹åŒ– ====================
            // å…³é”®ä¿®æ”¹ï¼šé€‚é…ä¸»è¿›ç¨‹å‘é€çš„æ—¥å¿—æ ¼å¼ï¼ˆ{content, type}ï¼‰
            ipcRenderer.on('comfy-log', (_, logData) => {
                // ä¸»è¿›ç¨‹å·²å¤„ç†æ—¶é—´æˆ³ï¼Œç›´æ¥æ¸²æŸ“å†…å®¹å’Œç±»å‹
                renderLog(logData.content, logData.type);
            });

            ipcRenderer.on('config-loaded', (_, config) => {
                // ç¡®ä¿é…ç½®å¯¹è±¡å­˜åœ¨
                const loadedConfig = config || {};
                pythonPathInput.value = loadedConfig.pythonPath || '';
                comfyuiDirInput.value = loadedConfig.comfyuiDir || '';
                comfyPortInput.value = loadedConfig.port || 8188;
                proxyModeSelect.value = loadedConfig.proxy || 'disabled';
                proxyUrlInput.value = loadedConfig.proxyUrl || '';
                customCmdInput.value = loadedConfig.customCmd || '';
                pluginCheckDaysInput.value = loadedConfig.pluginCheckDays || 7;
                toggleProxyInput();
                if (pythonPathInput.value) checkPythonPath();
                if (comfyuiDirInput.value) checkComfyuiDir();
                checkPort();
            });

            ipcRenderer.on('show-config', showConfigPanel);

            document.addEventListener('DOMContentLoaded', () => {
                initConfigDrag();
                initLogResize();
                initShortcut();
                renderLog('âœ… ComfyUIå¯åŠ¨å™¨å°±ç»ªï¼Œè¯·å…ˆå®Œæˆé…ç½®å†å¯åŠ¨', 'success');
                pythonPathInput.addEventListener('blur', checkPythonPath);
                comfyuiDirInput.addEventListener('blur', checkComfyuiDir);
                comfyPortInput.addEventListener('blur', checkPort);
                pluginCheckDaysInput.addEventListener('input', () => {
                    const val = parseInt(pluginCheckDaysInput.value);
                    if (val < 1) pluginCheckDaysInput.value = 1;
                    if (val > 30) pluginCheckDaysInput.value = 30;
                });
            });

        } catch (err) {
            alert(`å‰ç«¯è„šæœ¬æ‰§è¡Œé”™è¯¯ï¼š${err.message}\nè¯·æ£€æŸ¥Electronç¯å¢ƒæˆ–ä»£ç æ˜¯å¦å®Œæ•´`);
            console.error('å‰ç«¯è„šæœ¬é”™è¯¯ï¼š', err);
        }
    </script>
</body>
</html>
