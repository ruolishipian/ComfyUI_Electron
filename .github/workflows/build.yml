name: Electron æç®€æ„å»º & åŒç‰ˆæœ¬å‘å¸ƒ

permissions:
  contents: write

on:
  push:
    tags: [ 'v*' ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…Node.js 18.x
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–ï¼ˆä»…ç”Ÿäº§ç¯å¢ƒï¼Œä½¿ç”¨å›½å†…é•œåƒï¼‰
        run: |
          npm config set registry https://registry.npmmirror.com
          # ğŸ‘‡ æ ¸å¿ƒä¿®æ”¹ï¼š--omit=dev ä¸å®‰è£…å¼€å‘ä¾èµ–ï¼Œå¤§å¹…å‡å°ä½“ç§¯
          npm install --omit=dev
        shell: pwsh

      - name: æ¸…ç†electron-builderç¼“å­˜
        run: |
          Remove-Item -Recurse -Force $env:LOCALAPPDATA\electron-builder\Cache -ErrorAction SilentlyContinue
          Remove-Item -Recurse -Force node_modules\.cache\electron-builder -ErrorAction SilentlyContinue
        shell: pwsh
        continue-on-error: true

      - name: ğŸ§¹ æ³¨å…¥æ¸…ç†è„šæœ¬ï¼ˆä¿ç•™ä¸­è‹±æ–‡ï¼Œåˆ é™¤å…¶ä»–è¯­è¨€åŒ…ï¼‰
        run: |
          $script = @'
          const fs = require('fs');
          const path = require('path');
          
          function cleanLocales(appPath) {
            const localesPath = path.join(appPath, 'locales');
            if (fs.existsSync(localesPath)) {
              fs.readdirSync(localesPath).forEach(file => {
                // åªä¿ç•™ zh-CN (ç®€ä½“ä¸­æ–‡) å’Œ en-US (è‹±æ–‡)
                if (!file.includes('zh-CN') && !file.includes('en-US')) {
                  try {
                    fs.unlinkSync(path.join(localesPath, file));
                    console.log('ğŸ—‘ï¸ åˆ é™¤å†—ä½™è¯­è¨€åŒ…:', file);
                  } catch (e) {}
                }
              });
            }
          }
          
          exports.default = async (context) => {
            console.log('ğŸ§¹ å¼€å§‹æ¸…ç†éæ ¸å¿ƒæ–‡ä»¶...');
            cleanLocales(context.appOutDir);
          }
          '@
          Set-Content -Path "clean-locales-plugin.js" -Value $script
        shell: pwsh

      - name: æ‰“åŒ… (ä»…å®‰è£…åŒ…+å‹ç¼©åŒ…)
        run: |
          npx electron-builder --win --x64 --publish never `
            --config.afterPack=./clean-locales-plugin.js
        shell: pwsh

      - name: ä¸Šä¼ åˆ° Releases
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            dist/*.exe
            dist/*.zip
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ä¸Šä¼ åˆ° Artifacts (å¤‡ç”¨)
        uses: actions/upload-artifact@v4
        with:
          name: ComfyUI_Electron-Core
          path: |
            dist/*.exe
            dist/*.zip
          retention-days: 30